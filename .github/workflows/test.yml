name: facet-scheming-test
run-name: ${{ github.actor }} probando facet-scheming-test
on: [push, pull_request]
jobs:
  lint:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: 3.9
      - name: check pip version
        run: pip --version
      - name: Install requirements
        run: pip install flake8 pycodestyle
      - name: Check syntax
        run: flake8 . --count --select=E901,E999,F821,F822,F823 --show-source --statistics --exclude ckan

  test:
    needs: lint
    #strategy:
    #  matrix:
    #    ckan-version: ["2.10", 2.9]
    #  fail-fast: false
    name: CKAN 2.9
    runs-on: ubuntu-20.04
    container:
      image: ghcr.io/mjanez/ckan-base-spatial:ckan-2.9.9
      #${{ matrix.ckan-version }}
    services:
      solr:
        image: ckan/ckan-solr:2.9
      postgres:
        image: ckan/ckan-postgres-dev:2.9
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
      redis:
          image: redis:3
    env:
      CKAN_SQLALCHEMY_URL: postgresql://ckan_default:pass@postgres/ckan_test
      CKAN_DATASTORE_WRITE_URL: postgresql://datastore_write:pass@postgres/datastore_test
      CKAN_DATASTORE_READ_URL: postgresql://datastore_read:pass@postgres/datastore_test
      CKAN_SOLR_URL: http://solr:8983/solr/ckan
      CKAN_REDIS_URL: redis://redis:6379/1

    steps:
      - uses: actions/checkout@v3
      #- uses: actions/setup-python@v4
      #  with:
      #    python-version: '3.9'
    #    - uses: actions/checkout@v3
    #      with:
    #        repository: mjanez/ckanext-scheming
      - name: Actualize pip
        run: |
          pip3 --version
          pip3 install --upgrade pip
          pip3 install setuptools wheel
          #python --version
          #python -m pip install --upgrade pip
          #pip install -r requirements.txt
          #pip --version
      - name: Install requirements
        run: |
          pip3 --version
          # pwd
          echo $GITHUB_WORKSPACE
          # ls -al $GITHUB_WORKSPACE
          pip3 install --upgrade pip
          pip3 install -r requirements.txt
          pip3 install -e .
          pip3 install -e "git+https://github.com/ckan/ckanext-scheming.git#egg=ckanext-scheming"
          pip3 install -e "git+https://github.com/ckan/ckanext-dcat.git#egg=ckanext-dcat"
          pip3 install -r /srv/app/src/ckanext-dcat/requirements.txt
          pip3 install -e "git+https://github.com/ckan/ckanext-spatial.git@v2.0.0#egg=ckanext-spatial"
          pip3 install -r /srv/app/src/ckanext-spatial/requirements.txt
          pip3 install -e "git+https://github.com/ckan/ckanext-harvest.git#egg=ckanext-harvest"
          pip3 install -r /srv/app/src/ckanext-harvest/requirements.txt
          
          # Replace default path to CKAN core config file with the one on the container
          sed -i -e 's/use = config:.*/use = config:\/srv\/app\/src\/ckan\/test-core.ini/' test.ini
          # sed -i -e 's/use = config:.*/use = config:\/srv\/app\/src\/ckan\/test-core.ini/' test_subclass.ini
      - name: Setup extension
        run: |
          ckan -c test.ini db init
      - name: Run all tests
        run: | 
          pip install -r test-requirements.txt
          pytest --ckan-ini=test.ini --cov=ckanext.facet_scheming ckanext/facet_scheming/tests
      #- name: Run plugin subclassing tests
      #  run: pytest --ckan-ini=test_subclass.ini ckanext/scheming/tests/test_dataset_display.py ckanext/scheming/tests/test_form.py::TestDatasetFormNew ckanext/scheming/tests/test_dataset_logic.py